
h1. Dowsers Entity





h1. Terminology

Adapted from JSR 351

**Entity**
An object that may be identified or described by a collection of Attributes.

**Attribute**
A named value.

**Attribute Value**
A quantitative or existential representation of the property or characteristic conveyed by the Attribute. A value may be empty (as distinct from the Attribute being undefined), a scalar, an Object, or a collection of Objects.

**Identity Attribute**
An Attribute that identify a specific instance of an entity.

**Attribute Meta-data**
A uniform taxonomy of characteristics that may be associated with an Attribute and where such characteristics are deemed necessary or appropriate to effect or enable the use of the value. Such information may establish its validity period, or more generally define constraints or tags that effect the use of the value.

**Entity Meta-data**
A collection of Attribute Meta-data which apply on a specific entity version.  

**Entity Meta-data Context**
A collection of Attribute Meta-data which apply on a specific entity. Generally its an instance of entity meta-data.
But, it could be an aggregation of entity meta-data.


**Meta Entity Reference**
An attribute that identify or describe a meta entity/ entity class name

urn:dowsers:{entity class name}

**Entity Reference**
A collection of Attributes that identify or describe an Entity. 

urn:dowsers:{meta entity reference}:identity@{identity attribute}

**Attribute Reference**
A representation of an Attribute that does not convey the value of the associated Attribute, that may be communicated between Entities without exposing the Attribute value.

urn:dowsers:{meta entity reference}:{attribute name}@{entity identity attribute}

**Meta Entity Context Provider**
A service which build meta entity context from meta entity provider.

**Meta Entity Repository**
A service or data store that contains meta data on Entity and Attribute values.


h1. Entity


An entity is defined by:
* An unique identity. Her identity does not change when any of its attributes change
* A set of attributes

Examples: Customer, Order, Organization, Car ...
 
Attributes are characteristics of entities


h2. Identity as Reference

Wikipedia's entry on the philosophical meaning of identity starts:

In philosophy, identity is whatever makes an entity definable and recognizable, in terms of possessing a set of qualities or characteristics that distinguish it from entities of a different type. Or, in layman's terms, identity is whatever makes stuff the same or different.



h3. Reference and URN

URN: http://en.wikipedia.org/wiki/Uniform_resource_name

A uniform resource name (URN) is a uniform resource identifier (URI) that uses the urn scheme and does not imply availability of the identified resource.


Example:

# urn:dowsers:org.intelligentsia.dowsers.sample.entity.User:identity#6787007f-f424-40b7-b240-64206b1177e2

# urn:dowsers:org.intelligentsia.dowsers.sample.entity.User:name#6787007f-f424-40b7-b240-64206b1177e2 

(1) reference a specific entity instance of User identified by '6787007f-f424-40b7-b240-64206b1177e2. 
(2) reference attribute 'name' of instance identified by '6787007f-f424-40b7-b240-64206b1177e2' with kind org.intelligentsia.dowsers.sample.entity.User.


org.intelligentsia.dowsers.sample.entity.User is the entity part

6787007f-f424-40b7-b240-64206b1177e2 is the identifier part

Note that an entity reference and a reference on identity entity's attribute is exactly the same thing


h3. Reference Provider

p. To obtain a new Reference instance, you must call:

bc. 
References.newReference(clazz)

p. Reference are created by a provider which implements ReferenceFactory interface.
The system lookup using ServiceLoader to find one. 
By default Dowsers use this class: 'com.intelligentsia.dowsers.entity.reference.ReferenceFactoryProvider' 

bc.. 
public interface ReferenceFactory {
	/**
	 * @param clazz
	 *            entity class name
	 * @return an new {@link Reference} for specified class name
	 */
	Reference newReference(Class<?> clazz);
}

p. Default implementation use an Identity provider act as a factory of identifier.
IdentifierFactoryProvider lookup in class path using ServiceLoader in order to find am implementation of IdentifierFactory.
A default provider is based on UUID scheme:

bc.. 
	/**
	 * IdentifierFactory declare methode to generate new identifier.
	 * 
	 * <pre>
	 * IdentifierFactoryProvider.generateNewIdentifier();
	 * 
	 * <pre>
	 * 
	 * @author <a href="mailto:jguibert@intelligents-ia.com" >Jerome Guibert</a>
	 */
	public interface IdentifierFactory {

		/**
		 * @return a new generated identifier.
		 */
		public abstract String generateNewIdentifier();

	}
 
	/**
	 * 
	 * DefaultIdentifierFactory extends abstract and use UUID class as
	 * identifier.
	 * 
	 * @author <a href="mailto:jguibert@intelligents-ia.com" >Jerome Guibert</a>
	 */
	private class DefaultIdentifierFactory implements IdentifierFactory {

		/**
		 * @see org.intelligentsia.dowsers.domain.IdentifierFactory#generateNewIdentifier()
		 */
		@Override
		public String generateNewIdentifier() {
			return UUID.randomUUID().toString();
		}

	}


h2. What is a value object (an attribute) ? 

“A Value Object cannot live on its own without an Entity.”
 
Eric Evans:
“An object that represents a descriptive aspect of the domain with no conceptual identity is called a VALUE OBJECT. VALUE OBJECTS are instantiated to represent elements of the design that we care about only for what they are, not who or which they are.” 
[Evans 2003]


Technically, a value class should :
* be serializable
* have a default constructor
* have only getter
* all member marked as final



h2. Interface entity 

Declare methods to :
* get entity's identity
* get/set attribute value
* test if entity contains a specific attribute name
* get a set of attributes contained in the entity

bc.. 
public interface Entity extends Identified<Reference>  {

	Reference identity();

	public <Value> Value attribute(String name) throws NullPointerException, IllegalArgumentException;

	public <Value> Entity attribute(String name, final Value value) throws NullPointerException, IllegalArgumentException;

	public boolean contains(String name) throws NullPointerException, IllegalArgumentException;

	public ImmutableSet<String> attributeNames();
	
	public MetaEntityContext metaEntityContext();
	
p. Main implementation of this interface is EntityDynamic and EntityProxy.

EntityDynamic is base class for all entities.

EntityProxy implements an InvokerHandler in order to create a proxy dynamic on a EI (entity as interface).


h1. Meta Data


h2. Meta Attribute


h2. Meta Entity


h2. Meta data Extension mechanism


h1. Use case

h2. Organization entity

h2. Customization of Organization


h1. Entity Serialization

h2. Technology

h2. Json/XML Format

h2. Register Custom Jackson Module


Under package: com.intelligentsia.dowsers.entity.serializer

EntityMapper need an instance of MetaEntityContextProvider, and expose two method:

	/**
	 * Method that can be used to serialize any Java value as JSON output, using
	 * Writer provided.
	 * 
	 * @param writer
	 * @param value
	 * @throws DowsersException
	 */
	public void writeValue(final Writer writer, final Object value) throws DowsersException {
		. . . 
	}

	/**
	 * Method that can be used to parse JSON to specified Java value, using
	 * reader provided.
	 * 
	 * @param reader
	 * @param valueType
	 * @return
	 * @throws DowsersException
	 */
	public <T> T readValue(final Reader reader, final Class<T> valueType) throws DowsersException {
		. . . 
	}


Dowsers module for Jackson project: com.intelligentsia.dowsers.entity.serializer.EntityDowsersJacksonModule

ObjectMapper mapper;

mapper.registerModule(new EntityDowsersJacksonModule(metaEntityContextProvider))





h1. Spring integration



h2. Configuration sample


bc.. 
	<bean
		class="com.intelligentsia.dowsers.entity.manager.MetaEntityProviderFactory">
		<property name="enableDynamicAnalyzer" value="true" />
		<!-- <property name="metaEntityProvider"></property> -->
	</bean>


	<bean 
		class="com.intelligentsia.dowsers.entity.manager.MetaEntityContextProviderFactory">
		<property name="enableCache" value="true" />
	</bean>

	<bean
		class="com.intelligentsia.dowsers.entity.manager.EntityFactoryProviderFactory">
		<property name="enableDefaultFactory" value="true" />
		<!-- factories -->
	</bean>

	<bean class="com.intelligentsia.dowsers.entity.manager.EntityStoreFactory">
		<property name="enableCachedEntities" value="true" />
		<property name="entityStore">
			<bean
				class="com.intelligentsia.dowsers.entity.store.memory.InMemoryEntityStore">
				<constructor-arg index="0">
					<bean
						class="com.intelligentsia.dowsers.entity.manager.EntityMapperFactory" />
				</constructor-arg>
			</bean>
		</property>
	</bean>

	<bean id="entityManager"
		class="com.intelligentsia.dowsers.entity.manager.EntityManagerFactory" />


p. 


bc.. 
	<bean
		class="com.intelligentsia.dowsers.entity.manager.MetaEntityProviderFactory">
		<property name="enableDynamicAnalyzer" value="true" />
		<!-- <property name="metaEntityProvider"></property> -->
	</bean>


	<bean 
		class="com.intelligentsia.dowsers.entity.manager.MetaEntityContextProviderFactory">
		<property name="enableCache" value="true" />
	</bean>

	<bean
		class="com.intelligentsia.dowsers.entity.manager.EntityFactoryProviderFactory">
		<property name="enableDefaultFactory" value="true" />
		<!-- factories -->
	</bean>

	<bean class="com.intelligentsia.dowsers.entity.manager.EntityStoreFactory">
		<property name="enableCachedEntities" value="true" />
		<property name="entityStore">
			<bean
				class="com.intelligentsia.dowsers.entity.store.memory.InMemoryEntityStore">
				<constructor-arg index="0">
					<bean
						class="com.intelligentsia.dowsers.entity.manager.EntityMapperFactory" />
				</constructor-arg>
			</bean>
		</property>
	</bean>

	<bean id="entityManager"
		class="com.intelligentsia.dowsers.entity.manager.EntityManagerFactory" />


p. 
